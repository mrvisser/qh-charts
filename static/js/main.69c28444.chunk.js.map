{"version":3,"sources":["hooks/useObservable.ts","services/MetricsStore.ts","components/Charts.tsx","services/FileStore.ts","components/FileDropZone.tsx","App.tsx","reportWebVitals.ts","setupHighcharts.ts","index.tsx"],"names":["useObservable","observableGenerator","deps","initialValue","React","useState","value","setValue","cb","useCallback","useEffect","o","undefined","sub","subscribe","error","err","console","next","unsubscribe","MetricsStoreContext","createContext","MetricsStore","fileStore","bloodGlucose$","this","filesByType$","pipe","concatMap","files","of","Promise","resolve","a","csvs","map","file","data","atob","bytes","Uint8Array","length","i","charCodeAt","TextDecoder","decode","all","parseBloodGlucoseCsv","timeValuesArr","timeValues","reduce","acc","m","Object","keys","timeStr","str","time","moment","tz","toDate","sort","b","getTime","fn","input","accept","reject","csvParse","split","slice","join","columns","records","result","record","parseValue","parseFloat","isNaN","ChartsContainer","styled","div","ChartContainer","ChartHeading","h2","Chart","Charts","metricsStore","useContext","ms","_","chain","groupBy","format","toPairs","day","sortBy","bloodGlucoseData","highchartsOptions","setHighchartsOptions","allValues","flatMap","bg","p","min","Math","floor","yMinMax","max","ceil","options","createHighchartsOptionsForDay","endOf","startOf","title","highcharts","Highcharts","xMinMax","values","dayMax","dayAvg","round","v","dayMin","maxLabel","avgLabel","chart","events","render","destroy","renderer","label","toString","add","attr","style","x","plotWidth","plotLeft","y","yAxis","toPixels","getBBox","height","margin","fontFamily","type","colors","credits","enabled","legend","plotOptions","series","gapSize","gapUnit","marker","radius","name","text","xAxis","dateTimeLabelFormats","plotBands","color","from","to","plotLines","compact","dashStyle","width","zIndex","tickInterval","FileStoreContext","FileStore","files$$","BehaviorSubject","files$","asObservable","fs","filter","f","fileList","unsupported","fileListItem","item","preProcessFileData","arrayBuffer","push","url","fetch","response","contentType","headers","get","concat","uniqBy","readData","resolveFileType","buffer","btoa","byte","String","fromCharCode","size","byteLength","startsWith","endsWith","Container","FileDropZone","children","fileService","onDragOver","ev","preventDefault","stopPropagation","onDrop","preProcessFiles","dataTransfer","preProcessed","acceptFiles","GlobalStyle","createGlobalStyle","reset","Fullscreen","PrintWrapper","App","dataUrl","csvFiles","preProcessUrl","Provider","display","justifyContent","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","brokenAxis","timezoneOffset","getTimezoneOffset","URLSearchParams","window","location","search","ReactDOM","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.69c28444.chunk.js","sourcesContent":["/* eslint-disable react-hooks/exhaustive-deps */\nimport React from 'react';\nimport { Observable } from 'rxjs';\n\nexport type ObserverFunction<T> = () => Observable<T> | undefined;\n\n/** @see [useObservable(observableGenerator, deps, initialvalue?)] */\nexport function useObservable<T>(\n  observableGenerator: ObserverFunction<T>,\n  deps: React.DependencyList,\n): [T | undefined];\n\n/** @see [useObservable(observableGenerator, deps, initialvalue?)] */\nexport function useObservable<T>(\n  observableGenerator: ObserverFunction<T>,\n  deps: React.DependencyList,\n  initialValue: T,\n): [T];\n\n/**\n * A custom hook that exposes an observable as its latest emitted value.\n *\n * @param observableGenerator A factory function for the observable\n * @param deps The dependency array. When any of these dependencies changes, the observable will\n *   be regenerated.\n * @param initialValue The initial value of the observable value, before it emits its first value.\n *   When the dependency array changes, the value will not revert to the initial value.\n * @returns\n */\nexport function useObservable<T>(\n  observableGenerator: ObserverFunction<T>,\n  deps: React.DependencyList,\n  initialValue?: T,\n): [typeof initialValue] {\n  const [value, setValue] = React.useState<T | typeof initialValue>(\n    initialValue,\n  );\n  const cb = React.useCallback(observableGenerator, deps);\n\n  /** When the callback changes, reinvoke it and subscribe to the new observable. */\n  React.useEffect(() => {\n    const o = cb();\n    if (o !== undefined) {\n      // eslint-disable-next-line deprecation/deprecation\n      const sub = o.subscribe({\n        // eslint-disable-next-line no-console\n        error: (err) => console.error(err),\n        next: setValue,\n      });\n      return () => sub.unsubscribe();\n    }\n  }, [cb]);\n\n  return [value];\n}\n","import csvParse from 'csv-parse';\nimport moment from 'moment-timezone';\nimport React from 'react';\nimport { Observable, of } from 'rxjs';\nimport { concatMap } from 'rxjs/operators';\n\nimport { FileStore } from './FileStore';\n\nexport type MetricValue<T> = {\n  time: Date;\n  value: T;\n};\n\ntype CsvRecord = {\n  'Device Timestamp': string;\n  'Record Type': string;\n  'Historic Glucose mmol/L': string;\n  'Scan Glucose mmol/L': string;\n};\n\nexport const MetricsStoreContext = React.createContext<MetricsStore>(\n  (undefined as unknown) as MetricsStore,\n);\n\nexport class MetricsStore {\n  constructor(private readonly fileStore: FileStore) {}\n\n  /** Observe changes to the blood glucose metrics. */\n  public readonly bloodGlucose$: Observable<\n    MetricValue<number>[] | undefined\n  > = this.fileStore\n    .filesByType$('csv')\n    .pipe(\n      concatMap((files) =>\n        of<() => Promise<MetricValue<number>[] | undefined>>(\n          () => Promise.resolve(undefined),\n          async () => {\n            const csvs = files.map((file) => {\n              const data = atob(file.data);\n              const bytes = new Uint8Array(data.length);\n              for (let i = 0; i < data.length; i++) {\n                bytes[i] = data.charCodeAt(i);\n              }\n              return new TextDecoder('utf-8').decode(bytes);\n            });\n            const timeValuesArr: Record<string, number>[] = await Promise.all(\n              csvs.map(parseBloodGlucoseCsv),\n            );\n            const timeValues = timeValuesArr.reduce(\n              (acc, m) => ({ ...acc, ...m }),\n              {},\n            );\n            return Object.keys(timeValues)\n              .map((timeStr) => {\n                const value = timeValues[timeStr];\n                const time = parseTime(timeStr);\n                return { time, value };\n              })\n              .sort((a, b) => a.time.getTime() - b.time.getTime());\n          },\n        ),\n      ),\n    )\n    .pipe(concatMap((fn) => fn()));\n}\n\nfunction parseBloodGlucoseCsv(input: string): Promise<Record<string, number>> {\n  return new Promise((accept, reject) => {\n    csvParse(\n      input.split('\\n').slice(1).join('\\n'),\n      { columns: true },\n      (err, records: CsvRecord[]) => {\n        if (err !== undefined) {\n          return reject(err);\n        }\n\n        const result: Record<string, number> = {};\n        for (const record of records) {\n          const value = parseValue(record);\n          if (value !== undefined) {\n            result[record['Device Timestamp']] = value;\n          }\n        }\n\n        accept(result);\n      },\n    );\n  });\n}\n\nfunction parseTime(str: string): Date {\n  return moment.tz(str, 'DD-MM-YYYY HH:mm', 'America/Toronto').toDate();\n}\n\nfunction parseValue(record: CsvRecord): number | undefined {\n  const value =\n    record['Record Type'] === '0'\n      ? parseFloat(record['Historic Glucose mmol/L'])\n      : parseFloat(record['Scan Glucose mmol/L']);\n  if (!isNaN(value)) {\n    return value;\n  } else {\n    return undefined;\n  }\n}\n","import * as Highcharts from 'highcharts';\nimport HighchartsReact from 'highcharts-react-official';\nimport _ from 'lodash';\nimport moment from 'moment-timezone';\nimport React from 'react';\nimport { map } from 'rxjs/operators';\nimport styled from 'styled-components';\n\nimport { useObservable } from '../hooks/useObservable';\nimport { MetricsStoreContext } from '../services/MetricsStore';\n\nconst ChartsContainer = styled.div`\n  margin: auto;\n`;\n\nconst ChartContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  margin: 0 20px;\n`;\n\nconst ChartHeading = styled.h2`\n  font-weight: 600;\n  margin: 5px 0 0 0;\n  text-align: center;\n  text-transform: uppercase;\n`;\n\nconst Chart = styled.div`\n  flex: 1;\n`;\n\nexport const Charts: React.FC = () => {\n  const metricsStore = React.useContext(MetricsStoreContext);\n  const [bloodGlucoseData] = useObservable(\n    () =>\n      metricsStore.bloodGlucose$\n        .pipe(\n          map((ms) =>\n            ms !== undefined\n              ? ms.map(({ time, value }) => [time.getTime(), value] as const)\n              : undefined,\n          ),\n        )\n        .pipe(\n          map((ms) => {\n            if (ms !== undefined) {\n              return _.chain(ms)\n                .groupBy(([time]) => moment(time).format('YYYY-MM-DD'))\n                .toPairs()\n                .map(([day, data]) => ({ data, day }))\n                .sortBy('day')\n                .value();\n            } else {\n              return undefined;\n            }\n          }),\n        ),\n    [metricsStore],\n  );\n  const [highchartsOptions, setHighchartsOptions] = React.useState<\n    {\n      title: string;\n      options: Highcharts.Options;\n    }[]\n  >();\n\n  React.useEffect(() => {\n    if (bloodGlucoseData !== undefined) {\n      const allValues = bloodGlucoseData.flatMap((bg) =>\n        bg.data.map((p) => p[1]),\n      );\n      const min = Math.floor(Math.min(4, ...allValues));\n      const max = Math.ceil(Math.max(7, ...allValues));\n      const yMinMax = { max, min };\n      setHighchartsOptions(\n        bloodGlucoseData.map(({ data, day }) => {\n          const m = moment.tz(day, 'America/Toronto');\n          const xMinMax = {\n            max: m.endOf('day').toDate().getTime(),\n            min: m.startOf('day').toDate().getTime(),\n          };\n          return {\n            options: createHighchartsOptionsForDay(data, xMinMax, yMinMax),\n            title: m.format('dddd, MMMM Do'),\n          };\n        }),\n      );\n    } else {\n      setHighchartsOptions(undefined);\n    }\n  }, [bloodGlucoseData]);\n\n  return (\n    <ChartsContainer>\n      {highchartsOptions !== undefined\n        ? highchartsOptions.map(({ title, options }) => {\n            return (\n              <ChartContainer key={title}>\n                <ChartHeading>{title}</ChartHeading>\n                <Chart>\n                  <HighchartsReact highcharts={Highcharts} options={options} />\n                </Chart>\n              </ChartContainer>\n            );\n          })\n        : undefined}\n    </ChartsContainer>\n  );\n};\n\nfunction createHighchartsOptionsForDay(\n  data: (readonly [number, number])[],\n  xMinMax: { min: number; max: number },\n  yMinMax: {\n    min: number;\n    max: number;\n  },\n): Highcharts.Options {\n  const values = data.map((p) => p[1]);\n  const dayMax = Math.max(...values);\n  const dayAvg =\n    values.length > 0\n      ? Math.round(\n          (values.reduce((acc, v) => acc + v, 0) * 10) / values.length,\n        ) / 10\n      : undefined;\n  const dayMin = Math.min(...values);\n  let maxLabel: Highcharts.SVGElement | undefined = undefined;\n  let avgLabel: Highcharts.SVGElement | undefined = undefined;\n\n  return {\n    chart: {\n      events: {\n        render() {\n          if (maxLabel !== undefined) {\n            maxLabel.destroy();\n            maxLabel = undefined;\n          }\n\n          if (avgLabel !== undefined) {\n            avgLabel.destroy();\n            avgLabel = undefined;\n          }\n\n          if (dayMax !== undefined) {\n            maxLabel = this.renderer.label(dayMax.toString(), -100).add();\n            maxLabel.attr({\n              style: 'font-weight: bold',\n              x: this.plotWidth + this.plotLeft,\n              y:\n                this.yAxis[0].toPixels(dayMax, false) -\n                maxLabel.getBBox().height / 2,\n            });\n          }\n\n          if (dayAvg !== undefined) {\n            avgLabel = this.renderer.label(dayAvg.toString(), -100).add();\n            avgLabel.attr({\n              x: this.plotWidth + this.plotLeft,\n              y:\n                this.yAxis[0].toPixels(dayAvg, false) -\n                avgLabel.getBBox().height / 2,\n            });\n          }\n        },\n      },\n      height: 225,\n      margin: [10, 50, 50, 50],\n      style: {\n        fontFamily: 'Poppins',\n      },\n      type: 'spline',\n      //width: '100%',\n    },\n    colors: ['rgba(255, 102, 102, 1)'],\n    credits: {\n      enabled: false,\n    },\n    legend: {\n      enabled: false,\n    },\n    plotOptions: {\n      series: {\n        gapSize: 30 * 60 * 1000,\n        gapUnit: 'value',\n        marker: {\n          enabled: true,\n          radius: 3,\n        },\n      },\n    },\n    series: [\n      {\n        data,\n        name: 'mmol/L',\n        type: 'spline',\n      },\n    ],\n    title: {\n      text: '',\n    },\n    xAxis: {\n      ...xMinMax,\n      dateTimeLabelFormats: {\n        day: '%H:%M',\n      },\n      type: 'datetime',\n    },\n    yAxis: {\n      ...yMinMax,\n      plotBands: [\n        {\n          color: 'rgba(87, 220, 140, 0.2)',\n          from: 4.1,\n          to: 6,\n        },\n      ],\n      plotLines: _.compact([\n        dayMax !== undefined\n          ? {\n              color: '#aaa',\n              dashStyle: 'Dot',\n              value: dayMax,\n              width: 2,\n              zIndex: 2,\n            }\n          : undefined,\n        dayAvg !== undefined\n          ? {\n              color: '#aaa',\n              dashStyle: 'Dash',\n              value: dayAvg,\n              width: 4,\n              zIndex: 2,\n            }\n          : undefined,\n        dayMin !== undefined\n          ? {\n              color: '#aaa',\n              dashStyle: 'Dot',\n              value: dayMin,\n              width: 2,\n              zIndex: 2,\n            }\n          : undefined,\n      ]),\n      tickInterval: 0.5,\n      title: {\n        text: '',\n      },\n    },\n  };\n}\n","import _ from 'lodash';\nimport React from 'react';\nimport { BehaviorSubject, Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nexport type FileType = 'image' | 'csv';\n\nexport type File = {\n  contentType: string;\n  data: string;\n  name: string;\n  size: number;\n  type: FileType;\n};\n\nexport type ProcessedFiles = {\n  files: File[];\n  unsupported: string[];\n};\n\nexport const FileStoreContext = React.createContext<FileStore>(\n  (undefined as unknown) as FileStore,\n);\n\nexport class FileStore {\n  private readonly files$$ = new BehaviorSubject<File[]>([]);\n  public readonly files$ = this.files$$.asObservable();\n\n  public filesByType$(type: FileType): Observable<File[]> {\n    return this.files$.pipe(map((fs) => fs.filter((f) => f.type === type)));\n  }\n\n  public async preProcessFiles(fileList: FileList): Promise<ProcessedFiles> {\n    const files: File[] = [];\n    const unsupported: string[] = [];\n\n    for (let i = 0; i < fileList.length; i++) {\n      const fileListItem = fileList.item(i);\n      if (fileListItem !== null) {\n        const file = await this.preProcessFileData(\n          fileListItem.name,\n          fileListItem.type,\n          () => fileListItem.arrayBuffer(),\n        );\n\n        if (file !== undefined) {\n          files.push(file);\n        } else {\n          unsupported.push(fileListItem.name);\n        }\n      }\n    }\n    return { files, unsupported };\n  }\n\n  public async preProcessUrl(url: string): Promise<ProcessedFiles> {\n    const response = await fetch(url);\n    const contentType = response.headers.get('content-type');\n    const name = url.split('?')[0].split('/').slice(-1)[0];\n    const file = await this.preProcessFileData(\n      name,\n      contentType === null ? 'application/octet-stream' : contentType,\n      () => response.arrayBuffer(),\n    );\n    if (file !== undefined) {\n      return { files: [file], unsupported: [] };\n    } else {\n      return { files: [], unsupported: [url] };\n    }\n  }\n\n  public async acceptFiles(files: File[]): Promise<void> {\n    this.files$$.next(\n      _.chain(this.files$$.value).concat(files).uniqBy('data').value(),\n    );\n  }\n\n  private async preProcessFileData(\n    name: string,\n    contentType: string,\n    readData: () => Promise<ArrayBuffer>,\n  ): Promise<File | undefined> {\n    const type = resolveFileType(name, contentType);\n    if (type !== undefined) {\n      const buffer = await readData();\n      const data = base64EncodeBuffer(buffer);\n      const size = buffer.byteLength;\n      return { contentType, data, name, size, type };\n    } else {\n      return undefined;\n    }\n  }\n}\n\nfunction base64EncodeBuffer(buf: ArrayBuffer): string {\n  return btoa(\n    new Uint8Array(buf).reduce(\n      (str, byte) => str + String.fromCharCode(byte),\n      '',\n    ),\n  );\n}\n\nfunction resolveFileType(\n  name: string,\n  contentType: string,\n): FileType | undefined {\n  if (contentType.startsWith('text/csv')) {\n    return 'csv';\n  } else if (contentType.startsWith('image/')) {\n    return 'image';\n  } else if (contentType.startsWith('text/') && name.endsWith('csv')) {\n    return 'csv';\n  } else {\n    return undefined;\n  }\n}\n","/* eslint-disable no-console */\nimport React from 'react';\nimport styled from 'styled-components';\n\nimport { FileStoreContext } from '../services/FileStore';\n\nconst Container = styled.div`\n  min-height: 100%;\n  min-width: 100%;\n  position: relative;\n`;\n\nexport const FileDropZone: React.FC = ({ children }) => {\n  const fileService = React.useContext(FileStoreContext);\n  return (\n    <Container\n      onDragOver={(ev) => {\n        ev.preventDefault();\n        ev.stopPropagation();\n      }}\n      onDrop={async (ev) => {\n        ev.preventDefault();\n        ev.stopPropagation();\n        const preProcessed = await fileService.preProcessFiles(\n          ev.dataTransfer.files,\n        );\n        await fileService.acceptFiles(preProcessed.files);\n      }}\n    >\n      {children}\n    </Container>\n  );\n};\n","import React from 'react';\nimport styled, { createGlobalStyle } from 'styled-components';\nimport reset from 'styled-reset';\n\nimport { Charts } from './components/Charts';\nimport { FileDropZone } from './components/FileDropZone';\nimport { useObservable } from './hooks/useObservable';\nimport { FileStore, FileStoreContext } from './services/FileStore';\nimport { MetricsStore, MetricsStoreContext } from './services/MetricsStore';\n\nconst GlobalStyle = createGlobalStyle`\n  /* Global reset to remove all browser styling. */\n  ${reset}\n\n  @page {\n    margin: 0;\n    size: A4;\n  }\n\n  html,\n  body,\n  #root {\n    height: 100%;\n    width: 100%;\n  }\n\n  body {\n    font-family: 'Poppins', 'Roboto', 'Helvetica Neue', sans-serif;\n  }\n`;\n\nconst Fullscreen = styled.div`\n  align-items: center;\n  display: flex;\n  justify-content: center;\n  min-height: 100%;\n  position: absolute;\n  min-width: 100%;\n`;\n\nconst PrintWrapper = styled.div`\n  width: 100%;\n  @media print {\n    max-width: 8in;\n  }\n`;\n\nexport type AppProps = {\n  dataUrl: string | undefined;\n};\n\nconst App: React.FC<AppProps> = ({ dataUrl }) => {\n  const [fileStore] = React.useState(() => new FileStore());\n  const [metricsStore] = React.useState(() => new MetricsStore(fileStore));\n  const [csvFiles] = useObservable(\n    () => fileStore.filesByType$('csv'),\n    [fileStore],\n    [],\n  );\n\n  React.useEffect(() => {\n    if (dataUrl !== undefined) {\n      void (async () => {\n        const { files } = await fileStore.preProcessUrl(dataUrl);\n        await fileStore.acceptFiles(files);\n      })();\n    }\n  }, [dataUrl, fileStore]);\n\n  return (\n    <>\n      <GlobalStyle />\n      <FileStoreContext.Provider value={fileStore}>\n        <MetricsStoreContext.Provider value={metricsStore}>\n          <FileDropZone>\n            {csvFiles.length > 0 ? (\n              <div style={{ display: 'flex', justifyContent: 'center' }}>\n                <PrintWrapper>\n                  <Charts />\n                </PrintWrapper>\n              </div>\n            ) : dataUrl === undefined ? (\n              <Fullscreen>\n                <span>\n                  Drag and drop a CSV file to graph it. Add as many as you like.\n                </span>\n              </Fullscreen>\n            ) : (\n              <Fullscreen>\n                <span>Download data...</span>\n              </Fullscreen>\n            )}\n          </FileDropZone>\n        </MetricsStoreContext.Provider>\n      </FileStoreContext.Provider>\n    </>\n  );\n};\n\nexport default App;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler): void => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    void import('web-vitals').then(\n      ({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n        getCLS(onPerfEntry);\n        getFID(onPerfEntry);\n        getFCP(onPerfEntry);\n        getLCP(onPerfEntry);\n        getTTFB(onPerfEntry);\n      },\n    );\n  }\n};\n\nexport default reportWebVitals;\n","import * as Highcharts from 'highcharts';\nimport brokenAxis from 'highcharts/modules/broken-axis';\nimport moment from 'moment-timezone';\n\nbrokenAxis(Highcharts);\nHighcharts.setOptions({\n  time: {\n    timezoneOffset: moment.tz('America/Toronto').toDate().getTimezoneOffset(),\n  },\n});\n","import React from 'react';\nimport ReactDOM from 'react-dom';\n\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nimport './setupHighcharts';\n\nconst qs = new URLSearchParams(window.location.search);\nconst dataUrl = qs.get('dataUrl');\n\nReactDOM.render(\n  <React.StrictMode>\n    <App dataUrl={typeof dataUrl === 'string' ? dataUrl : undefined} />\n  </React.StrictMode>,\n  document.getElementById('root'),\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}